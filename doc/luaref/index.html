
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for the Idun Cartridge for Commodore 128 and 64">
      
      
        <meta name="author" content="Brian">
      
      
        <link rel="canonical" href="https://idun-project.github.io/doc/luaref/">
      
      
        <link rel="prev" href="../apiref/">
      
      
        <link rel="next" href="../eram/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.13">
    
    
      
        <title>Lua - Idun Cartridge Manual</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#idun-to-lua-interface" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Idun Cartridge Manual" class="md-header__button md-logo" aria-label="Idun Cartridge Manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Idun Cartridge Manual
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lua
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="amber"  aria-hidden="true"  type="radio" name="__palette" id="__palette_0">
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Idun Cartridge Manual" class="md-nav__button md-logo" aria-label="Idun Cartridge Manual" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Idun Cartridge Manual
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../setup-rpi/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Setup
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idun-base/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Included Samples
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idun-cpem/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    CP/M Support
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idun-filebrowser/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Web File Access
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idunSID/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Audio Streaming
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idun-vice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Emulator
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" checked>
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Programming
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            Programming
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../apiref/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ACE API
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Lua
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Lua
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#idun-to-lua-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Idun to Lua Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idun to Lua Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mini-socket" class="md-nav__link">
    <span class="md-ellipsis">
      mini socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idun-handler" class="md-nav__link">
    <span class="md-ellipsis">
      idun handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m8-api" class="md-nav__link">
    <span class="md-ellipsis">
      m8 API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="m8 API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#low-level-m8-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Low-level m8 functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#high-level-m8-functions" class="md-nav__link">
    <span class="md-ellipsis">
      High-level m8 functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m8x-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      m8x extensions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-sys-functions" class="md-nav__link">
    <span class="md-ellipsis">
      System (sys.) functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-usr-functions" class="md-nav__link">
    <span class="md-ellipsis">
      User (usr.) functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../eram/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    ERAM
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../toolbox/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Toolbox
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../idun-zcc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Z80
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#idun-to-lua-interface" class="md-nav__link">
    <span class="md-ellipsis">
      Idun to Lua Interface
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Idun to Lua Interface">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mini-socket" class="md-nav__link">
    <span class="md-ellipsis">
      mini socket
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#idun-handler" class="md-nav__link">
    <span class="md-ellipsis">
      idun handler
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m8-api" class="md-nav__link">
    <span class="md-ellipsis">
      m8 API
    </span>
  </a>
  
    <nav class="md-nav" aria-label="m8 API">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#low-level-m8-functions" class="md-nav__link">
    <span class="md-ellipsis">
      Low-level m8 functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#high-level-m8-functions" class="md-nav__link">
    <span class="md-ellipsis">
      High-level m8 functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#m8x-extensions" class="md-nav__link">
    <span class="md-ellipsis">
      m8x extensions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#system-sys-functions" class="md-nav__link">
    <span class="md-ellipsis">
      System (sys.) functions
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#user-usr-functions" class="md-nav__link">
    <span class="md-ellipsis">
      User (usr.) functions
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>Lua</h1>

<h2 id="idun-to-lua-interface">Idun to Lua Interface<a class="headerlink" href="#idun-to-lua-interface" title="Permanent link">&para;</a></h2>
<hr />
<h3 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h3>
<p>Idun provides several methods by which Lua code running on the Raspberry Pi can provide coprocessing functionality to idun tools and applications. First, let's describe the three basic ways of integrating Lua code, from simplest to most complicated:</p>
<ol>
<li>Write a Lua script and execute it in a tty from the idun-shell.</li>
</ol>
<p>This is by far the easiest way to add applications written in Lua. The idun-shell has a <code>lua</code> command that will accept the name of a Lua script and launch it in a terminal. So, a simple text program written in Lua and using the Lua <code>print()</code> function would just work. To see this in action, switch to the <code>idun-base/apps</code> (usually mapped to <code>e:</code>) directory and type <code>lua sieve.lua</code>. The script is a generic thing that spits out prime numbers up to 10000. It only uses <code>print()</code> for output.</p>
<p>To do a more interactive program that requires user input, you simply switch the Lua stdio to use the <a href="#mini-socket">minisock</a> API described below. Now, every character typed or printed is available on both the Lua and C128 side. To see an example of a script that works this way, simply type <code>help</code> or press <code>F1</code> in the shell. The help system is implemented as a <a href="https://github.com/idun-project/idun-cartridge/cbm/resc/help.lua">Lua script</a>.</p>
<ol>
<li>Write a Lua "server" that handles requests from your idun "client" application.</li>
</ol>
<p>Included with Idun is an <a href="#idun-handler">idun-handler</a> Lua object that makes it easy to create client/server applications where Lua does the "heavy lifting". For example, the <code>sidplay</code> command relies on a helpful <a href="https://github.com/idun-project/idun-cartridge/cbm/resc/sidplay.lua">Lua server</a> to pre-process the SID files. </p>
<ol>
<li>Write a "native" idun application in a combination of Lua and 6502 assembler.</li>
</ol>
<p>Finally, Idun supports creating applications in Lua in which the C128 is mainly the front-end for rendering graphics, playing sound, and receiving user inputs. In theory, all of the application logic and data processing can be done in Lua. </p>
<p>To communicate, messages are passed to the C128 using a "mailbox" interface, and these messages can be of arbitrary size and content. Even streaming data as fast as the C128 can handle it is possible. Likewise, there is an "event" interface that allows asynchronous events, like user input, to be forwarded to the Lua script. The two best, though simple, examples of this are e:mandelbrot.app and e:cube.app. These Lua/6502 assembler hybrid apps will even work in the idun-vice emulator.</p>
<p>Of course, complicated rendering like drawing polygons on the VDC hi-res display, and complicated input like using the mouse, needs support on the C128 side. This is the role of the <a href="#m8-api">m8 ("mate") API</a> and <a href="#m8x-extensions">m8x ("mate extensions")</a>.</p>
<h3 id="mini-socket">mini socket<a class="headerlink" href="#mini-socket" title="Permanent link">&para;</a></h3>
<p>Under the hood of the Lua interface is a dedicated local socket connection that passes the data stream between the C128 and your script. The <code>minisock</code> is actually a standard Lua way to talk to a socket, and it is augmented by a second Lua object <code>redirect</code>.</p>
<p>In the simplest case, the normal way of outputting text to <code>stdout</code> and inputting text from <code>stdin</code> is modified as so:</p>
<ul>
<li>Instead of <code>print(str)</code> or <code>io.write(str)</code>, you use <code>minisock.write(redirect.stdout, str)</code>.</li>
<li>Instead of <code>io.read()</code>, you use <code>key = minisock.read(redirect.stdin, 10000)</code>. The number is a timeout value given in milliseconds; so, 10 seconds for this example. This is just the maximum time you want your script to block waiting on a keystroke from the user. It can be 0 ms to make it non-blocking, or a very big number if you want to block "forever". More practically, place it in a loop that polls for other things or does other work.</li>
</ul>
<p>Minisock can of course be used in a more structured way, such as for passing pre-defined requests and responses between assembler and Lua code. This is where idun-handler provides a helpful and simple solution.</p>
<h3 id="idun-handler">idun handler<a class="headerlink" href="#idun-handler" title="Permanent link">&para;</a></h3>
<p>The handler is included, so you can just <code>require("idun-handler")</code> in your script. Then, you implement a function to handle the requests that your assembler code will send to Lua. In <a href="https://github.com/idun-project/idun-cartridge/cbm/resc/sidplay.lua">sidplay.lua</a>, for example, the <code>handleRequest(req)</code> function supports 2 types of requests using this simple bit of Lua script:</p>
<div class="codehilite"><pre><span></span><code>    -- Allowed requests: &quot;H&quot;=get sid header, &quot;P&quot;=get sid program
    if req == &quot;H&quot; then
        return sidhdr
    elseif req == &quot;P&quot; then
        -- Prepend with the size
        local resp = string.pack(&quot;&lt;H&quot;, #sidprg)
        return resp .. sidprg
    else
        return nil, 3   -- Bad request
    end
</code></pre></div>

<p>Since this isn't the Web, you don't need fancy long names. An "H" request and a "P" request are sufficient, and these are sent as two-byte messages from the C128 ("H\n" or "P\n"). So, 8-bit efficiency is maintained.</p>
<p>Likewise, the response to the "P" request is many kilobytes of SID tune data. However, the assembler side just has to copy all that data to RAM as fast as it can read it from the cartridge port.</p>
<h3 id="m8-api">m8 API<a class="headerlink" href="#m8-api" title="Permanent link">&para;</a></h3>
<p>The m8 (say "Mate") API is what allows code written in Lua to run on the Raspberry Pi's processor, but call into 8-bit machine code that's running on the 6502 CPU in your Commodore 128. It's akin to "old school" programming on the Commodore using BASIC to call machine language routines, except the high-level script is Lua and runs on a powerful ARM coprocessor. To use m8, just add a line like <code>local m8 = require("m8api")</code> to your Lua program.</p>
<h4 id="low-level-m8-functions">Low-level m8 functions<a class="headerlink" href="#low-level-m8-functions" title="Permanent link">&para;</a></h4>
<p>All of the functionality in m8 is ultimately based on just two low-level functions:</p>
<div class="codehilite"><pre><span></span><code>1. m8.load({6502_ml_code}, load_addr, [start_addr])
2. m8.intr({6502_ml_code})
</code></pre></div>

<p>The <code>m8.load</code> function takes some ml code written for the 6502, and quickly loads it into the Commodore at the memory location specified by <code>load_addr</code>. An optional <code>start_addr</code>, if provided, causes a <code>jmp</code> to that address as soon as the code has been loaded. The size of the 6502_code blob that is downloaded to the Commodore is only limited by the RAM available to the 6502.</p>
<p>The <code>m8.intr</code> function is used to invoke some inline ml code, which might be as simple as a <code>jsr</code> call to a subroutine in the Commodore memory. Such a subroutine may be a user routine loaded via <code>m8.load</code>, a routine in a running application or tool, an Idun Kernel routine, or even a  routine in Commodore ROM.</p>
<p>Since the 6502_code that is provided to <code>m8.intr</code> may be <em>up to 512 bytes</em>, it can be much more complex than just calling a subroutine. Another common use-case would be to treat it as a traditional interrupt handler such that Lua code can both trigger a Commodore interrupt, and provide the handler to run in response, through a simple call to <code>m8.intr</code>.</p>
<h4 id="high-level-m8-functions">High-level m8 functions<a class="headerlink" href="#high-level-m8-functions" title="Permanent link">&para;</a></h4>
<p><strong>UNDER CONSTRUCTION</strong></p>
<p><code>m8.mailbox</code> is the standard API for message passing from Lua to assembler.</p>
<p><code>m8.waitevent</code> is the standard API for receiving input events from assembler in Lua.</p>
<p><code>m8.writeln</code> is for outputting lines of text to the display for a full-screen Lua application. For console applications in Lua, you can just use minisock or the Lua <code>print()</code> function.</p>
<p><code>m8.file.load_prg</code> is for loading/starting a native program from a Lua script.</p>
<h3 id="m8x-extensions">m8x extensions<a class="headerlink" href="#m8x-extensions" title="Permanent link">&para;</a></h3>
<p>m8x ("mate extensions") is the standard way to add application-dependent functionality to Lua apps. These extensions become part of the callable code in the m8 namespace created by the applications. So, it allows new functionality to be invoked on the assembler side. For an example, see: <a href="https://github.com/idun-project/idun-cartridge/samples/cube.app.d/">cube.app.d</a> and <a href="https://github.com/idun-project/idun-cartridge/samples/mandelbrot.app.d/">mandelbrot.app.d</a>.</p>
<h3 id="system-sys-functions">System (sys.) functions<a class="headerlink" href="#system-sys-functions" title="Permanent link">&para;</a></h3>
<p><strong>UNDER CONSTRUCTION</strong></p>
<h3 id="user-usr-functions">User (usr.) functions<a class="headerlink" href="#user-usr-functions" title="Permanent link">&para;</a></h3>
<p><strong>UNDER CONSTRUCTION</strong></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.expand", "navigation.sections", "search.suggest", "content.code.copy"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>